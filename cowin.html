<!DOCTYPE html>
<html lang="en">
<meta charset="UTF-8">
<title>Vaccine tracker</title>

<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
        integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
</head>

<body>
    <div class="container">

        <form>
            <h2 class="form-signin-heading">Covid vaccine notifier</h2>
            <div class="form-group">
                <label for="age">Age</label>
                <input placeholder="Age 18 or 45" class="form-control" id="age" type="number" value="18" min="18"
                    max="45" required />

            </div>
            <div class="form-group">
                <label for="freq">Frequency</label>
                <input placeholder="Enter Frequency" class="form-control" id="freq" type="number" value="3000"
                    min="1000" required />
            </div>
            <div class="form-group">

                <label for="pin">Pincode</label>
                <input placeholder="Enter Pincode" class="form-control" id="pin" type="number" value="313001"
                    required />
            </div>
            <div class="form-group">
                <label for="datePicker">Date</label>
                <input id="datePicker" class="form-control" type="date" required />
            </div>
            <div class="form-group"></div><button class="btn btn-primary" type="button" onclick="callApi()">Run</button>
            <button class="btn btn-primary" type="button" onclick="stopScript()">Stop</button>
            <div id="idDiv" class="form-group">
        </form>
    </div>

    <script>
        function callCoWinApi(pin, date) {
            fetch("https://cdn-api.co-vin.in/api/v2/appointment/sessions/public/findByPin?pincode=" + pin + "&date=" + date).then(response => response.json())
                .then(data => {
                    if (data.sessions.length > 0) {
                        var below45Data = data.sessions.filter(item => item.min_age_limit == document.getElementById("age").value && item.available_capacity > 0)
                        if (below45Data.length > 0) {
                            fetch('/sendMail');
                            document.getElementById("idDiv").innerHTML = "<p>" + JSON.stringify(below45Data) + "</p>";
                            var centers = below45Data.map(i => i.address).toString();
                            stopScript(`${new Date()} - Slot found at ${centers} Mail Sent. Script stopped.`);
                        }
                    }
                });
        }
        var apiInterval;
        function callApi() {
            document.getElementById("idDiv").innerHTML = "Script Running";
            if (document.getElementById("freq").value > 1000) {
                var date = new Date(document.getElementById("datePicker").value);
                var getMonth = Number.parseInt(date.getMonth(), 10) + 1;
                var dateValue = date.getDate() + "-" + getMonth + "-" + date.getFullYear();
                apiInterval = setInterval(callCoWinApi.bind({}, document.getElementById("pin").value, dateValue), document.getElementById("freq").value);
            }
        }
        function stopScript(msg) {
            clearInterval(apiInterval);
            if (msg) {
                document.getElementById("idDiv").innerHTML = msg;
            } else {
                document.getElementById("idDiv").innerHTML = "Script Stopped";
            }
        }
        window.onload = function () {
            var date = new Date();
            document.getElementById('datePicker').value = date.getFullYear().toString() + '-' + (date.getMonth() + 1).toString().padStart(2, 0) +
                '-' + date.getDate().toString().padStart(2, 0);
            document.getElementById('pin').value = "313001";
        }
    </script>
</body>

</html>